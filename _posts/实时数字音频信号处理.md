---
layout:     post                    # 使用的布局（不需要改）
title:      实时数字音频信号处理               # 标题 
subtitle:                           #副标题
date:       2022-10-08              # 时间
author:     Aaron Mao               # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - DSP
---

<head>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
</head>


> **This is a note about Realtime DSP**  
> **Reference: 《实时数字信号处理 实践方法与应用 第二版》**

# 1. 从模拟信号到数字信号

## 1.1 模数转换

我们用计算机处理的是数字信号，需要将模拟信号先转换到数字信号（模数转换ADC)  
ADC的过程就是采样，量化，编码，其中：

- **采样定理：**  
用周期冲击函数（周期 $T$）从连续信号采样，频域上是频谱的周期延拓，频率是 $\Omega_s=\frac{2\pi}{T}$, 采样频率 $F_s=\frac{1}{\Omega_s}$

- **奈奎斯特定律**  
采样频率大于两倍信号最高频率 $F_s > 2 f_h$,否则会频谱混叠

- **抗混叠滤波器：**  
采样定理的前提是信号带限，有最高频率。但是在实际应用，模拟信号可能在感兴趣的最高频率之外还有很大能力，或者有宽带噪声，这时候一般采样率都是预先固定的。比如采样率8k的语音系统，实际语音的频率分量可能不止4k，为了满足采样定理，我们需要先滤掉高于4k的频率（用抗混叠滤波器）
实际中，一般用带通滤波器，不仅滤波高于奈奎斯特频率的分量，也要滤除直流偏移和其它低频分量。
进一步的，数字滤波器不是理想的模拟滤波器，不能完全达到滤波效果；即使是模拟滤波器，可能也会引入相位失真；但是对于高采样率系统，还是会用最小相位失真的简单低功耗反混叠滤波器
最小相位失真又怎么实现？（待补充)

- **量化：**  
离散数字信号幅度的强度就是（编码为）具有B个字节表示的二进制数字 $x(n)$
  - 将采样的幅度量化为 $2^B$ 个量化电平之一
  - 如果 $x(n)$ 刚好在两个量化电平之间，会做一个近似，这就会引入量化误差/噪
  - 量化噪声不超过量化间隔，量化位数越多，量化间隔越小，量化噪声越小

- **数模转换(DAC):**  
从量化电平重建模拟波形，一般会用低通滤波器使得阶梯状的模拟信号变平滑，如果高精度重建波形又是一个问题，不讨论。

## 1.2 DSP硬件简单了解

基本有五种硬件平台：

- 专用的芯片/集成电路（ASIC）
- FPGA
- 通用的微处理器/控制器：$\mu P / \mu C$
- 通用的DSP（数字信号处理器）：高速度、较好的能量效率和较低成本
- 特定硬件加速的DSP

DSP处理器可以分为定点和浮点

DSP有实时约束，要求信号处理加上IO开销的时间t小于一个采样周期T，因此限制了可以处理的最高频率，处理时间越长，可处理的带宽越低；虽然新的科技和优化不断推出，但是性能和成本还是有trade-off

## 1.3 数字音频基本常识

[https://www.jianshu.com/p/638fa13082eb?utm_campaign=maleskine](https://www.jianshu.com/p/638fa13082eb?utm_campaign=maleskine)

- **采样率**
模拟信号向数字信号转换过程中，数字转换设备每秒采集到的数量，单位为Hz
8kHz, 就是每秒8000个采样点

- **采样位数**
将采样的样本幅度进行量化，用多少个bit进行存储，比如16bit和24bit
也可以称为声卡的分辨率，数值越大，精度越高

- **比特率**
48kHz, 24bit 的立体声（2 channel），比特率48*24*2 = 2304 kbps

- **动态范围**
描述放大器在最大不失真的情况下，输入信号和放大器本底噪声信号的比（有一个复杂的计算公式）1bit深度的动态范围的增量是6dB
同一个音频工程导出同格式，24bit音频比16bit音频在动态上是高的

- **WAV格式**  
上面说的概念可能指的是PCM数据，是一个裸码流，由声道、采样位数、采样率和时长决定，如果你预先不知道这些信息，就无法提取正确提取音频
常见的WAV格式则是在PCM开头用额外44字节表征了以上的元信息

# 2 时频分析：

## 2.1 信号与系统基础

### 2.1.1 数字信号

之前提到，数字信号是用周期冲击函数（周期 $T_s$,采样频率 $f_s$）从连续信号采样，频域上是频谱的周期延拓

模拟信号:  $x(t)=Asin(\Omega t+\phi)=Asin(2\pi ft+\phi)$

数字信号:  $x(n)=Asin(\Omega nT_s+\phi)=Asin(2\pi fnT_s+\phi)$

数字信号的 数字角频率： $\Omega_s=\Omega T_s=\frac{2\pi f}{f_s}$，
假设 $f_s=8k, f=1k$，表示对0到 $2\pi $一个周期采样8个点， $\pi $对应了被采信号的最高频率
采样间隔： $T_s=\frac{1}{f_s}$

归一化数字角频率： $F=\frac{\Omega_s}{\pi}=\frac{2 f}{f_s}$,最大值为1

### 2.1.2 Z变换

#### 应用

用来分析离散时间系统  
用来创建改进后的滤波器，比如级联和并联多系统  
得到滤波器的传输函数，然后获得结构图

![FIR and RIR](https://itsMao.github.io/img/2022-10-08-img/212.jpeg)

#### 零极点分析

另外还可以零点极点直观地分析LTI系统的性质，Matlab使用`zplane(b, a)`, 极点是分母的根  
一个线性时不变系统H(z)当且仅当所有的极点都在单位圆内才是**稳定**的系统

#### 系统的频率响应

Matlab使用`[H, W]=freqz(b, a, N）`得到频率向量和**频响向量**  
DFT可以在X(w)单位圆采样，获得离散的频率响应


## 2.2 连续时间傅里叶变换

时域非周期，频域连续

有限（非周期）信号，在数学意义上延拓，满足狄利克雷条件也可以计算傅里叶级数

## 2.3 DTFT离散时间傅里叶变换

计算机处理的序列是有限离散的

时域**离散非周期**，频域**连续周期**，我们只看一段(-pi, pi)

但是频域信号，计算机也只能处理离散的一段信号（相当于离散非周期），那就需要DFT

## 2.4 DFT离散傅里叶变换

- DFT定义如下：
- DFT等价于在DTFT的频谱截取一个周期，然后以N点采样， $\omega=\frac{2\pi k}{N}$ 这样就得到了计算机可以处理的频域信号
- 经过DFT的信号，频谱是共轭对称的
- **频率分辨率：**  
y(t)时域采样Ns点后， $x[n]=y[0:Ns-1]$
作N点fft，输出复数 $X[w]$ 有N个频点， $\frac{Fs}{N},\frac{2Fs}{N},...,\frac{NFs}{N}$
- **绘图：**
默认的频谱图是以Fs/2为中心，两边对称的，后面是前面的共轭对称
- 实际计算中，用FFT算法计算DFT和iDFT


## 2.5 STFT短时傅里叶分析

傅立叶变换适合平稳确定信号，语音并不是，但是一个短时帧可以视为平稳确定信号，且很多场景是需要进行分帧处理的。

DTFT:

STFT就是再加一个滑动窗：

$$
X(n,\omega)=\sum^\infty_{m=-\infty}x(m)w(n-m)e^{-j\omega m}
$$

也可以看作是完整信号卷积一个窗（滤波）

实际中，不需要每个点都滑动一次，可以取一个overlap，比如每次移动窗长的50%



- **为什么加窗？**  
加窗其实就是为了截断信号，但是矩形窗会有截断效应，需要用hanning等窗来缓解
- **为什么要重叠**?  
语音信号是时变的，两帧之间的特征变化可能比较大，  
重叠就是为了保证信号特征变化的连续性，  
假设我们分帧边缘恰好是某个特征突然变化的地方，不用重叠的话，就捕捉不到这个变化
- 什么是**频谱泄漏**?  
原始信号加窗，如果没有截取一个完整的周期（N个采样点内没有振动整数个周期），产生**截断效应**，造成频谱泄漏：  
1、可能会造成频谱的扩散，比如拖尾或者变宽，频率信息流入到其它频带上； 
2、如果两个临近频率分别有一个峰值，可能弱一点的那个会被掩盖掉； 
- **缓解频谱泄漏：**  
一般用好一点的窗，比如hamming窗等，使得信号在0开始，在0结束，可以极大缓解频谱泄漏的影响


# 3. 离散序列的卷积：

我们在处理音频信号（可以称之为序列）的卷积的时候，一般不采用线性卷积的方式，而是采用快速卷积，即变换到频域，相乘，再逆变换到时域  
我们可能知道这个原理：时域卷积对应频域相乘  
但是，这是DTFT域的概念，序列是离散非周期，DTFT频谱是连续周期的，计算机无法计算  

实际上我们采用的是DFT（FFT算法）域处理，序列的圆周卷积对应DFT域的相乘，然后通过padding的方式使得圆周卷积和线性卷积的结果一致，这样，我们才能获得两个有限序列的卷积结果，这个方法又叫作**快速卷积**

在实时音频处理系统中，序列也不是整条一起处理的，而是会分帧卷积，就涉及到OLA/OLS等概念

## 3.1 为什么DFT可以作卷积

对于两个离散序列，用N点DFT相乘就可以计算线性卷积

![](https://secure2.wostatic.cn/static/nYGioQukq96K6UNbFZDNq1/image.png)

## 3.2 线性卷积与圆周卷积：

![](https://secure2.wostatic.cn/static/8qGeLsGTiF5DqQXkNsHw3b/image.png)

![](https://secure2.wostatic.cn/static/3aBKqfHeujcLJ37AZKjNyo/image.png)

**二者关系：**

两个有限长序列长度为 $N1$和 $N2$，直接卷积后长度为 $M=N1+N2-1$
如果先补到 $L≥M$， 圆周卷积前M个点和线性卷积的结果一致  
**如果补到L=M，圆周卷积和线性卷积结果一致**

推导：





## 3.3 直接卷积：

就是时间域卷积，时间复杂度 $O(n^2)$，而且长度会变

## 3.4 **快速卷积：**

就是先padding，然后在DFT域进行卷积

![](https://secure2.wostatic.cn/static/bdcc5Yn4nkbrLs4VmnJiuv/image.png)

### OLA：

MATLAB内置的`filtfilt(b, x, N)`底层就是使用OLA进行快速卷积

![](https://secure2.wostatic.cn/static/jaXLqe3wD8mrcw5TaZ5e7e/image.png)



### OLS:

![](https://secure2.wostatic.cn/static/vjMQskuB2andxKzLtmeKkB/image.png)

![](https://secure2.wostatic.cn/static/24S3VS2iQhWxMSjtSwpqkm/image.png)

### 分块卷积UPOLS:

![](https://secure2.wostatic.cn/static/toJNxRHa71Qgz5dm8pYFio/image.png)

假设将滤波器也分成帧长度大小B，  
每一帧和前面的帧一起组成2B长度的block，  
逐个和padding后长度为2B的滤波器block卷积，叠加，取最后B个点输出 

![](https://secure2.wostatic.cn/static/6dE7Wvb8thdRWohfDHyrZX/IMG_94644C2897BD-1.jpeg)

### Crossfading：

一般会用在滤波器切换

![](https://secure2.wostatic.cn/static/wtQysnoQidyux7oRpAJsst/image.png)

![](https://secure2.wostatic.cn/static/27dofFgTk2LunKeB4Hp6wJ/image.png)

## 3.5 FFT原理

跳过



# 4. 数字滤波器

这里只讨论线性滤波器，FIR和IIR

## 4.1 **FIR**

FIR和IIR的特点是八股文，需要背一下，当然更需要深入理解，具体是怎么卷积的？

### **4.1.1 特点：**

- 有限长度
- 非递归结构，没有反馈，**稳定**
- 有**线性相位**
- 硬件容易实现，可以有效地实现在大多数DSP处理器上
- 与IIR相比相同性能，**阶次较高**，误差较小，**增加了DSP计算量**

信号经过滤波器，幅度和相位可能会改变，如果滤波器的相位响应是线性，就是**线性相位滤波器**

根据幅度滤波效果，分为 低通、高通、带通和带阻滤波器  
理想情况下，我们滤波器类似于一个矩形窗，但是实际中频域是有一个过渡带的，设计的时候需要考虑

![](https://secure2.wostatic.cn/static/spe8fBFqMbB6Hbm6aLeHhc/IMG_BFF423334EE7-1.jpeg)



### 4.1.2 线性相位FIR滤波器：

如果FIR滤波器参数 是正对称或者负对称，那么相位响应为线性  
FIR滤波器长度 是偶数或者奇数，综上线性相位滤波器有4种组合  

如果是对称FIR滤波器，那么就可以用一对地址指针从buffer中同时获取两个点数据，共享一个滤波系数进行一次运算



### 4.1.3 **FIR滤波器实现**：

FIR滤波器适用于逐点和逐块的工作模式，比如分帧卷积
然后每一帧可以使用线性卷积或者快速卷积，快速卷积在前面已经讨论
线性卷积具体是怎么做的呢？信号样本循环缓冲，移动缓冲的起始指针，不断覆盖最后的值，不需要在物理内存中移动数据

![](https://secure2.wostatic.cn/static/vUQtPNRZRWFCbPxW1k3a4H/IMG_5A702916D938-1.jpeg)



### 4.1.4 FIR滤波器设计：

实质是决定一系列的滤波器系数以满足给定的要求

- 傅立叶序列方法：
用**双边脉冲响应去近似频响**，比如用**加窗截断**的sinc脉冲来近似一个矩形频响，平移一点就可以得到一个物理可实现的有限长度的FIR滤波器，假设取长度L，那就是对这个脉冲响应进行L点采样得到系数b  
- 吉布斯现象：
sinc脉冲加窗产生截断效应，幅度响应的通带和阻带都会出现波纹（拖尾），肩峰值的上限会随着长度N的增加而增加，最后趋于恒定值8.95%

    ![](https://secure2.wostatic.cn/static/rmNhNm7ghyGAZv1sEJodPS/image.png)

     

注意，到此有**截断效应，频谱泄漏和吉布斯效应**三个概念
截断效应是指信号加窗后（通常指理想的矩形窗）的出现的现象，包括频谱泄漏和吉布斯效应
频谱泄漏是定性分析，指的是展宽和拖尾现象导致信息流入其它频带
吉布斯效应是定量分析，是指肩峰值的极限
截断效应需要更好的窗函数来缓解

不过还有一种频谱泄漏，那就是做FFT本身导致的频谱分辨率不够，可以使用更大的N

### 4.1.5 窗函数：

为了保证 通带到阻带有快速转换，窗的主瓣宽度应该尽量小，频率精度高；
为了减小振荡波纹，旁瓣以下的区域应该尽量小，频谱泄漏小；
**这两个要求不能同时满足，只能有一个trade-off**

hamming窗提供了更好的通带低波纹和更好的阻带衰减，对LPF很合适

基于傅立叶级数和窗函数的FIR滤波器设计方法概括为：

- 决定窗口类型，满足阻带衰减的要求
- 根据给定的过渡带决定窗口的大小
- 计算窗口参数 $w(l),l=0,1,...,L-1$
- 产生理想冲击响应 $h(n)$,加窗截断得到 $h'(n)，-M≤n≤M$
- 将 $h'(n)$ 右移得到物理可实现滤波器 $b'_l$
- $b_l=b'_l\omega(l),l=0,1,...,L-1$

### 4.1.6 FIR滤波器的有限字长效应：

FIR滤波器的系数经常用浮点数描述，但是在定点处理器上量化执行

### 4.1.7 重采样：内插和抽取  

- **升采样内插+低通滤波器：**对于采样速率 $f_s$的信号，进入1:U的插入，插入U-1个点，采样速率增加到 $Uf_s$,
会出现镜像频率分量，用低通滤波去除掉折叠的谱，得到扩展频带之后的谱
- **低通抗混叠滤波器+降采样抽取**：  
例如16k到8k，如果原来的信号有效带宽（8k），在8k信号有效带宽（4k）以上有频率成分就会导致混叠，需要在抽取之前对原始信号在4k进行低通滤波，滤除高频，只保留采样后信号的有效带宽部分防止混叠
- 变换采样率：比如从32k到48k，不是整数比例，先内插到92k在抽取到48k，一定要先内插，否则直接抽取导致的损失无法通过内插还原
- Matlab命令：
`y = interp(x, U) `内插U倍长度  
`y = decimate(x, D, 'fir') `抽取  
`y = resample(x, U, D)`信号采样率转换，对x信号进行采样率U/D倍的转换

## 4.2 IIR

### 4.2.1 特点：

- 递归结构，**有反馈**回路，稳定性问题
- **非线性相位**，需要增加相位校准网络，会增加阶数
- 有历史的输出参与反馈，与FIR相比同性能需要的**阶数少**，**计算量小**
- IIR的设计是选一个滤波器（巴特沃斯切比雪夫等）然后根据设计参数和滤波器公式确定阶数，计算量小



### 4.2.2 模拟滤波器：

- 巴特沃斯：幅度响应单调，但是下降缓慢
- 切比雪夫：I型通带波纹、II型阻带波纹，下降区间更加陡峭
- 椭圆形滤波器：下降区间进一步更加陡峭，但是通带和阻带都有波纹
- 贝塞尔滤波器：

### 4.2.3 IIR滤波器设计-双线性变换法：

确定一个H(z),近似于给定的模拟滤波器H(s)，一般用双线性变换法和脉冲响应不变法，
脉冲不变法是将模拟滤波器直接数字化，会有混叠问题，不讨论；
**双线性变换法**保留幅度响应，比较适合用来设计选频IIR滤波器

#### 双线性变换法：

- 临界频率 $\omega_c$预规整，得到模拟滤波器频率 $\Omega_c=\frac{2}{T}tan(\frac{\omega}{2})$
- 用模拟频率模拟滤波器 $H(s)$进行尺度变换，得到传递函数$ \hat{H}(s)=H(s/\Omega_c)$
- 用双线性变换 $s=\frac{2}{T}\frac{z-1}{z+1}$替代 $s$，得到 $H(z)$



### 4.2.4 IIR滤波器实现：

有直接I型、直接II型、级联和并联型

Matlab：

- 求解分子分母的根：`b = root(r1), a = root(r2)`
- 求解零点、极点、增益：`[z,p,c]=tf2zp(b,a)`
- 返回转移函数的系数：`[b, a]=zp2tf(z,p,k)`

### 4.2.5 MATLAB IIR滤波器设计：

N是阶数，Wn是频率伸缩因子

`[N, Wn] = buttord(Wp, Ws, Rp, Rs); % 巴特沃斯滤波器`
其它滤波器，有cheblord, ellip等

`[b, a] = butter(N, Wn);  `% 默认低通滤波器，如果需要其它滤波器就加参数比如‘high'

返回的b，a就是两个滤波器系数向量

滤波：`y = filter(b, a, x)`

```MATLAB
% 0-800Hz通带，波纹小于1.0dB，1600-4000阻带，衰减至少20dB
Wp = 800 / 4000;    % 归一化的通带截止频率
Ws = 1600 / 4000;
Rp = 1.0;
Rs = 20.0;
[N, Wn] = buttord(Wp, Ws, Rp, Rs); % 巴特沃斯滤波器
[b, a] = butter(N, Wn);
y = filter(b, a, x)；

% 100-200Hz通带，波纹小于1.0dB，阻带50-100 200-250，衰减至少20dB
Wp = [100 200] / 4000;    % 归一化的通带截止频率
Ws = [50 250] / 4000;
Rp = 1.0;
Rs = 20.0;

```

### 4.2.6 稳定性和有限精度

要考虑IIR的稳定性，提前进行验证，比如二阶IIR，使得a1a2确定的点在一个三角形内

系数量化后，本来稳定的极点可能跑到单位圆外了，一般用并联和级联形式会更好

### 4.2.7 IIR滤波器应用

循环振荡器、EQ参数均衡